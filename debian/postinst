#!/bin/bash
# Post-installation script for speech-to-text package
# Runs as root after package installation

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_step() {
    echo -e "${BLUE}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# Detect the actual user (not root)
if [ -n "$SUDO_USER" ]; then
    ACTUAL_USER="$SUDO_USER"
elif [ -n "$PKEXEC_UID" ]; then
    ACTUAL_USER=$(getent passwd "$PKEXEC_UID" | cut -d: -f1)
else
    ACTUAL_USER=$(logname 2>/dev/null || echo "$USER")
fi

# Get user's home directory
ACTUAL_HOME=$(getent passwd "$ACTUAL_USER" | cut -d: -f6)

if [ -z "$ACTUAL_USER" ] || [ -z "$ACTUAL_HOME" ]; then
    print_error "Could not detect actual user. Please run with sudo."
    exit 1
fi

echo ""
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║      Speech-to-Text Post-Installation Setup             ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
print_step "Installing for user: $ACTUAL_USER"

# Ask user for model size
echo ""
print_step "Select Whisper model size"
echo ""
echo "  1) tiny   [39 MB,  fastest, lower accuracy]"
echo "  2) base   [140 MB, fast, good accuracy]"
echo "  3) small  [460 MB, recommended for multilingual] (RECOMMENDED)"
echo "  4) medium [1.5 GB, slow, high accuracy]"
echo "  5) large  [3+ GB,  slowest, best accuracy]"
echo ""
read -p "Choice [3]: " MODEL_CHOICE

case "$MODEL_CHOICE" in
    1) MODEL="tiny" ;;
    2) MODEL="base" ;;
    4) MODEL="medium" ;;
    5) MODEL="large" ;;
    *) MODEL="small" ;;  # Default
esac

print_success "Selected model: $MODEL"

# Create Python virtual environment
print_step "Creating Python virtual environment"
VENV_PATH="/opt/speech-to-text/venv"
if [ ! -d "$VENV_PATH" ]; then
    python3 -m venv "$VENV_PATH"
    print_success "Virtual environment created at $VENV_PATH"
else
    print_success "Virtual environment already exists"
fi

# Install Python packages
print_step "Installing Python packages"
"$VENV_PATH/bin/pip" install --upgrade pip
"$VENV_PATH/bin/pip" install faster-whisper evdev numpy soundfile
print_success "Python packages installed"

# Update service file to use system venv
print_step "Configuring systemd service"
SERVICE_FILE="/usr/lib/systemd/user/speech-to-text.service"
# Update paths in service file
sed -i "s|/home/dev/speech-env|$VENV_PATH|g" "$SERVICE_FILE"
sed -i "s|/home/dev/speech-to-text|/opt/speech-to-text|g" "$SERVICE_FILE"
sed -i "s|WorkingDirectory=.*|WorkingDirectory=/opt/speech-to-text|g" "$SERVICE_FILE"
print_success "Service file configured"

# Create user configuration directory
print_step "Setting up user configuration"
CONFIG_DIR="$ACTUAL_HOME/.config/speech-to-text"
CONFIG_FILE="$CONFIG_DIR/config.toml"

# Create config directory as actual user
sudo -u "$ACTUAL_USER" mkdir -p "$CONFIG_DIR"

# Copy config if it doesn't exist
if [ ! -f "$CONFIG_FILE" ]; then
    sudo -u "$ACTUAL_USER" cp /etc/speech-to-text/config.toml.default "$CONFIG_FILE"
    # Update model
    sed -i "s/^model = .*/model = \"$MODEL\"/" "$CONFIG_FILE"
    # Enable clipboard mode
    sed -i "s/^mode = .*/mode = \"clipboard\"/" "$CONFIG_FILE"
    chown "$ACTUAL_USER:$ACTUAL_USER" "$CONFIG_FILE"
    print_success "Configuration created at $CONFIG_FILE"
else
    print_warning "Configuration already exists, not overwriting: $CONFIG_FILE"
fi

# Add user to input group
print_step "Configuring user permissions"
if groups "$ACTUAL_USER" | grep -q '\binput\b'; then
    print_success "User already in 'input' group"
else
    usermod -aG input "$ACTUAL_USER"
    print_success "User added to 'input' group"
fi

# Enable systemd service for user
print_step "Enabling systemd service"
# Run systemctl as actual user
export XDG_RUNTIME_DIR="/run/user/$(id -u "$ACTUAL_USER")"
if sudo -u "$ACTUAL_USER" systemctl --user enable speech-to-text 2>/dev/null; then
    print_success "Service enabled for user $ACTUAL_USER"
else
    print_warning "Could not enable service automatically. Run manually after login:"
    print_warning "  systemctl --user enable speech-to-text"
fi

# Final message
echo ""
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║               Installation Complete!                     ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
print_success "Speech-to-Text installed successfully!"
echo ""
print_warning "IMPORTANT: You must logout and login again for the 'input' group membership to take effect."
echo ""
echo "After logout/login:"
echo "  - Service will start automatically"
echo "  - Hold Right Ctrl to record speech"
echo "  - First use will download the Whisper model (~$(
    case "$MODEL" in
        tiny) echo "39MB" ;;
        base) echo "140MB" ;;
        small) echo "460MB" ;;
        medium) echo "1.5GB" ;;
        large) echo "3GB+" ;;
    esac
) for '$MODEL')"
echo ""
echo "Useful commands:"
echo "  Start service:    systemctl --user start speech-to-text"
echo "  Stop service:     systemctl --user stop speech-to-text"
echo "  View logs:        journalctl --user -u speech-to-text -f"
echo "  Run tests:        /opt/speech-to-text/run.sh --test"
echo "  Interactive mode: /opt/speech-to-text/run.sh"
echo ""
echo "Configuration: $CONFIG_FILE"
echo ""
print_success "Model: $MODEL (clipboard mode enabled for mixed Latin/Cyrillic text)"
echo ""

exit 0
